generator client {
  provider = "prisma-client"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id            String   @id @default(uuid())
  name          String   @unique
  email         String   @unique
  password      String
  avatar        String?

  generatedImages Image[]     @relation("GeneratedBy")
  likedImages     ImageLike[]

  followers Follow[] @relation("Following")
  following Follow[] @relation("Follower")

  followerCount  Int @default(0)
  followingCount Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
}

model Image {
  id         String  @id @default(uuid())
  userId     String
  prompt     String  @db.Text
  model      Model   @default(flux)
  seed       Int     @unique
  user       User    @relation("GeneratedBy", fields: [userId], references: [id], onDelete: Cascade)
  s3Url      String
  isRemixed  Boolean @default(false)
  isPublic   Boolean @default(false)
  remixCount Int     @default(0)
  likeCount  Int     @default(0)

  createdAt DateTime @default(now())

  errorMessage String?

  updatedAt DateTime @updatedAt

  originalImageId String?
  originalImage   Image?  @relation("Remixes", fields: [originalImageId], references: [id], onDelete: Cascade)
  remixes         Image[] @relation("Remixes")

  likes ImageLike[]

  @@index([userId])
  @@index([isPublic, createdAt])
  @@index([originalImageId])
}

enum Model {
  flux
  gptimage
  nanobanana
  seedance
}

model ImageLike {
  id        String   @id @default(cuid())
  userId    String
  imageId   String
  createdAt DateTime @default(now())

  user  User  @relation(fields: [userId], references: [id])
  image Image @relation(fields: [imageId], references: [id], onDelete: Cascade)

  @@unique([userId, imageId])
  @@index([userId])
  @@index([imageId])
}

model Follow {
  id          String   @id @default(cuid())
  followerId  String
  followingId String
  createdAt   DateTime @default(now())

  follower  User @relation("Follower", fields: [followerId], references: [id], onDelete: Cascade)
  following User @relation("Following", fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
}
